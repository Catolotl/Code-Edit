<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Indy Code Studio Pro</title>
  <style>
    :root {
      --bg:#000; --sidebar:#0d0d0d; --panel:#161616;
      --accent:#6b46c1; --accent-hover:#7c3aed; --glow:#a78bfa;
      --text:#e6e6e6; --muted:#9a9a9a; --danger:#ef4444;
      --success:#10b981; --warning:#f59e0b;
    }
    *{box-sizing:border-box;font-family:'SF Mono','Monaco','Cascadia Code',ui-monospace,monospace}
    body{margin:0;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}

    #studio{position:fixed;inset:0;display:grid;grid-template-rows:52px 1fr;grid-template-columns:280px 1fr}

    #top{grid-column:1/-1;background:linear-gradient(to bottom,#0f0f0f,#0a0a0a);
      display:flex;gap:10px;align-items:center;padding:0 14px;border-bottom:1px solid #1f1f1f;
      box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    #filenameWrap{flex:1;display:flex;align-items:center;gap:8px}
    #filename{flex:1;background:#000;border:1px solid #2a2a2a;color:var(--text);
      padding:8px 12px;border-radius:8px;font-size:13px;transition:border 0.2s}
    #filename:focus{border-color:var(--accent);outline:none}
    #unsavedBadge{font-size:12px;color:var(--warning);display:none}
    
    .dropdown{position:relative;display:inline-block}
    .dropdown-btn{background:var(--accent);border:none;color:white;padding:8px 16px;
      border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;
      display:flex;align-items:center;gap:6px}
    .dropdown-btn:hover{background:var(--accent-hover);transform:translateY(-1px)}
    .dropdown-content{display:none;position:absolute;top:100%;right:0;margin-top:4px;
      background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;min-width:220px;
      box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:1000;overflow:hidden}
    .dropdown-content.show{display:block}
    .dropdown-item{padding:10px 14px;cursor:pointer;font-size:13px;display:flex;
      align-items:center;gap:8px;border-bottom:1px solid #252525}
    .dropdown-item:last-child{border-bottom:none}
    .dropdown-item:hover{background:#252525}
    .dropdown-item input[type="checkbox"]{cursor:pointer}
    
    .btn{background:var(--accent);border:none;color:white;padding:8px 16px;border-radius:8px;
      cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s;white-space:nowrap}
    .btn:hover{background:var(--accent-hover);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.danger{background:var(--danger)}
    .btn.danger:hover{background:#dc2626}
    .btn.secondary{background:#333;color:var(--text)}
    .btn.secondary:hover{background:#404040}
    .btn.success{background:var(--success)}
    .btn.success:hover{background:#059669}

    #sidebar{background:var(--sidebar);padding:12px;overflow:auto;border-right:1px solid #1a1a1a}
    #sidebar h3{margin:6px 0 12px;font-size:13px;color:#bbb;text-transform:uppercase;
      letter-spacing:0.5px;font-weight:600;display:flex;align-items:center;justify-content:space-between}
    .newFolderBtn{background:#1a1a1a;border:none;color:var(--text);padding:4px 8px;
      border-radius:4px;cursor:pointer;font-size:11px}
    .newFolderBtn:hover{background:#252525}
    
    #projectList{list-style:none;padding:0;margin:0 0 20px 0}
    .project-item{padding:10px 12px;border-radius:6px;cursor:pointer;background:#121212;
      margin-bottom:6px;transition:all 0.2s;display:flex;align-items:center;gap:8px}
    .project-item::before{content:'üì¶';font-size:16px}
    .project-item.active{background:var(--accent);box-shadow:0 2px 8px rgba(107,70,193,0.3)}
    .project-item:hover:not(.active){background:#1a1a1a}
    
    #files{list-style:none;padding:0;margin:0}
    .folder{margin-bottom:8px}
    .folder-header{padding:6px 8px;border-radius:6px;cursor:pointer;display:flex;
      align-items:center;gap:6px;font-size:13px;font-weight:600;background:#121212;
      transition:background 0.15s}
    .folder-header:hover{background:#1a1a1a}
    .folder-header.collapsed::before{content:'‚ñ∂'}
    .folder-header:not(.collapsed)::before{content:'‚ñº'}
    .folder-content{padding-left:16px;margin-top:4px}
    .folder-content.hidden{display:none}
    
    .file-item{padding:8px 10px;border-radius:6px;cursor:move;display:flex;
      align-items:center;gap:8px;font-size:13px;transition:all 0.15s;position:relative}
    .file-item::before{content:'üìÑ';font-size:14px}
    .file-item[data-ext="html"]::before{content:'üåê'}
    .file-item[data-ext="css"]::before{content:'üé®'}
    .file-item[data-ext="js"]::before{content:'‚ö°'}
    .file-item[data-ext="py"]::before{content:'üêç'}
    .file-item.active{background:var(--accent);box-shadow:0 0 0 1px var(--glow),0 2px 8px rgba(107,70,193,0.3)}
    .file-item:hover:not(.active){background:#1a1a1a}
    .file-item.dragging{opacity:0.5}
    .file-item.drag-over{border:2px dashed var(--accent)}
    .delete{margin-left:auto;opacity:0;padding:2px 6px;border-radius:4px;
      background:#333;font-size:11px;transition:opacity 0.2s}
    .file-item:hover .delete{opacity:1}
    .delete:hover{background:var(--danger)}

    #editorSection{position:relative;display:flex;flex-direction:column}
    #editorWrap{flex:1;display:grid;grid-template-columns:50px 1fr;background:#0b0b0b;position:relative}
    #editorWrap.pending::after{content:'';position:absolute;inset:0;
      background:linear-gradient(90deg,transparent,rgba(107,70,193,0.1),transparent);
      animation:shimmer 2s infinite;pointer-events:none}
    @keyframes shimmer{0%,100%{transform:translateX(-100%)}50%{transform:translateX(100%)}}
    
    #lines{background:#070707;color:#555;padding:12px 8px;text-align:right;
      border-right:1px solid #1a1a1a;font-size:13px;user-select:none;line-height:1.5;
      white-space:pre;overflow:hidden}
    #editor{background:transparent;color:var(--text);border:none;outline:none;
      resize:none;padding:12px;line-height:1.5;font-size:13px;tab-size:2;white-space:pre}
    
    #diffOverlay{position:absolute;top:0;left:50px;right:0;bottom:0;
      pointer-events:none;padding:12px;line-height:1.5;font-size:13px;white-space:pre;
      font-family:inherit;overflow:auto;display:none;z-index:2}
    #diffOverlay.active{display:block}
    .diff-add{background:rgba(16,185,129,0.12);border-left:3px solid var(--success);padding:6px;margin:4px 0;border-radius:6px}
    .diff-remove{background:rgba(239,68,68,0.12);border-left:3px solid var(--danger);text-decoration:line-through;padding:6px;margin:4px 0;border-radius:6px}

    /* diff controls dynamically offset to avoid Indy */
    #diffControls{position:absolute;top:10px;right:10px;display:none;gap:8px;z-index:120;
      background:rgba(10,10,10,0.95);padding:8px;border-radius:8px;border:1px solid #2a2a2a;
      box-shadow:0 4px 16px rgba(0,0,0,0.6)}
    #diffControls.active{display:flex}
    #diffControls::before{content:'AI Suggestion';position:absolute;top:-24px;left:0;
      font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    
    #highlightOverlay{position:absolute;top:0;left:50px;right:0;bottom:0;
      pointer-events:none;padding:12px;line-height:1.5;font-size:13px;white-space:pre;
      font-family:inherit;overflow:auto;z-index:1}
    .kw{color:#c678dd} /* keywords: purple */
    .str{color:#98c379} /* strings: green */
    .num{color:#d19a66} /* numbers: orange */
    .com{color:#5c6370;font-style:italic} /* comments: gray */
    .fn{color:#61afef} /* functions: blue */
    .var{color:#e06c75} /* variables: red */

    #welcomeScreen{grid-column:2;padding:40px;display:none;flex-direction:column;align-items:center;
      justify-content:center;text-align:center}
    #welcomeScreen.active{display:flex}
    #welcomeScreen h1{font-size:48px;margin:0 0 10px;background:linear-gradient(135deg,var(--accent),var(--glow));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    #welcomeScreen h2{font-size:24px;color:var(--muted);margin:0 0 40px;font-weight:400}
    .news-section{max-width:800px;width:100%;margin-top:40px}
    .news-item{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;
      padding:20px;margin-bottom:16px;text-align:left;transition:all 0.2s}
    .news-item:hover{border-color:var(--accent);transform:translateY(-2px)}
    .news-item h3{margin:0 0 8px;color:var(--glow);font-size:16px}
    .news-item p{margin:0;color:var(--muted);line-height:1.6;font-size:14px}
    .news-date{color:#666;font-size:12px;margin-top:8px}

    #previewPanel{position:fixed;right:0;top:52px;bottom:0;width:42%;
      background:#fff;border-left:1px solid #1a1a1a;transition:transform 0.3s;z-index:50}
    #previewPanel.collapsed{transform:translateX(100%)}
    #previewToggle{position:absolute;left:-40px;top:10px;background:var(--accent);
      border:none;color:white;padding:8px 12px;border-radius:8px 0 0 8px;cursor:pointer;
      font-size:18px;transition:background 0.2s}
    #previewToggle:hover{background:var(--accent-hover)}
    #previewError{background:#fee;color:#c00;padding:12px;font-size:12px;display:none;border-bottom:2px solid #f00}
    iframe{width:100%;height:100%;border:none}

    #indy{position:fixed;right:0;top:52px;bottom:0;width:380px;
      background:linear-gradient(to bottom,#0f0f0f,#0a0a0a);
      border-left:1px solid #2a2a2a;display:flex;flex-direction:column;
      box-shadow:-4px 0 16px rgba(0,0,0,0.4);z-index:90;transition:transform 0.3s ease}
    #indy.collapsed{transform:translateX(100%)}
    #indyToggle{position:absolute;left:-40px;top:50%;transform:translateY(-50%);
      background:linear-gradient(135deg,var(--accent),#4c1d95);border:none;color:white;
      padding:12px 10px;border-radius:8px 0 0 8px;cursor:pointer;font-size:18px;
      transition:all 0.2s;box-shadow:-2px 0 8px rgba(0,0,0,0.3);writing-mode:vertical-rl}
    #indyToggle:hover{background:linear-gradient(135deg,var(--accent-hover),#5b21b6);
      padding-left:12px}
    #indy header{padding:14px 16px;font-weight:600;border-bottom:1px solid #2a2a2a;
      display:flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--accent),#4c1d95)}
    #indy header::before{content:'ü§ñ';font-size:18px}
    #indy .log{flex:1;overflow:auto;padding:12px;font-size:12px;line-height:1.6}
    #indy .log b{color:var(--glow)}
    #indy .log .msg{margin:8px 0;padding:8px;border-radius:6px;background:#141414}
    #indy .log .code-suggestion{background:#1a1a1a;padding:10px;border-radius:6px;
      margin:8px 0;border-left:3px solid var(--accent)}
    #indy .log .code-suggestion pre{margin:8px 0;padding:8px;background:#0a0a0a;
      border-radius:4px;overflow-x:auto;font-size:11px}
    #indy .log .apply-btn{background:var(--success);color:white;border:none;
      padding:6px 12px;border-radius:6px;cursor:pointer;font-size:11px;margin-top:8px}
    #indy .log .apply-btn:hover{background:#059669}
    #indy input{border:none;border-top:1px solid #2a2a2a;background:#000;color:white;
      padding:12px;outline:none;font-size:13px}
    #indy input:focus{background:#0a0a0a}

    /* thinking animation */
    .thinking { display:inline-block; width:40px; text-align:center; }
    .thinking span { display:inline-block; width:8px; height:8px; margin:0 2px; background:#fff; border-radius:50%; opacity:.3; transform:translateY(0); animation:dot 1s infinite linear; }
    .thinking span:nth-child(2){ animation-delay:0.15s }
    .thinking span:nth-child(3){ animation-delay:0.3s }
    @keyframes dot { 50% { opacity: 1; transform:translateY(-6px); } 100% { opacity:.3; transform:translateY(0); } }

    .toast{position:fixed;bottom:80px;right:20px;background:var(--accent);color:white;
      padding:12px 20px;border-radius:8px;font-size:13px;opacity:0;transition:opacity 0.3s;
      pointer-events:none;z-index:1000;box-shadow:0 4px 16px rgba(0,0,0,0.4)}
    .toast.show{opacity:1}

    /* tutorial overlay */
    #tutorialOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1500;display:none;align-items:flex-start;justify-content:center}
    #tutorialOverlay.active{display:flex}
    .tutorial-step{background:#111;border:1px solid #222;padding:18px;border-radius:12px;color:var(--text);margin-top:80px;max-width:420px}
    .tutorial-step h3{margin:0 0 8px}
    .tutorial-arrow{position:absolute;width:220px;height:80px;background:transparent;pointer-events:none;transition:all 0.25s}
    .tutorial-controls{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .suggestion-dropdown{position:absolute;background:#111;border:1px solid #2a2a2a;padding:6px;border-radius:6px;z-index:200;display:none;min-width:160px}
    .suggestion-item{padding:6px 8px;cursor:pointer}
    .suggestion-item:hover{background:#222}

    /* small show-console button */
    #showConsoleBtn{position:fixed;right:12px;bottom:12px;padding:8px 10px;border-radius:8px;background:var(--accent);color:white;z-index:1000;display:none}
  </style>
</head>
<body>

<div id="studio">
  <div id="top">
    <div id="filenameWrap">
      <input id="filename" placeholder="filename.html" style="display:none">
      <span id="unsavedBadge">‚óè Unsaved</span>
    </div>
    <button class="btn secondary" id="backToProjects" style="display:none">‚Üê Projects</button>
    <button class="btn secondary" id="newProject">+ New Project</button>
    
    <div class="dropdown" id="fileDropdown" style="display:none">
      <button class="dropdown-btn">File ‚ñæ</button>
      <div class="dropdown-content">
        <div class="dropdown-item" id="newFile">üìÑ New File</div>
        <div class="dropdown-item" id="newFolder">üìÅ New Folder</div>
        <div class="dropdown-item" id="addImage">üñºÔ∏è Add Image</div>
        <div class="dropdown-item" id="rename">‚úèÔ∏è Rename</div>
        <div class="dropdown-item" id="deleteFile">üóëÔ∏è Delete</div>
        <div class="dropdown-item" id="makePy">üêç New Python File</div>
        <div class="dropdown-item" id="showTutorial">üß≠ Show Tutorial</div>
      </div>
    </div>
    
    <div class="dropdown" id="runDropdown" style="display:none">
      <button class="dropdown-btn">Run ‚ñæ</button>
      <div class="dropdown-content">
        <div class="dropdown-item" id="runNow">‚ñ∂ Run Now</div>
        <div class="dropdown-item" id="autoRunToggle">
          <input type="checkbox" id="autoRun"> Auto Run (saves then runs)
        </div>
        <div class="dropdown-item" id="togglePreview">üëÅÔ∏è Toggle Preview</div>
        <div class="dropdown-item" id="autoSuggestToggle">
          <input type="checkbox" id="autoSuggest"> Auto Suggestions
        </div>
      </div>
    </div>
    
    <button class="btn" id="save" style="display:none">üíæ Save</button>
    <button class="btn secondary" id="pyMaker" style="display:none">PY Maker</button>
  </div>

  <div id="sidebar">
    <h3>Projects</h3>
    <ul id="projectList"></ul>
    <div id="fileSection" style="display:none">
      <h3>Files</h3>
      <div id="files"></div>
    </div>
  </div>

  <div id="welcomeScreen" class="active">
    <h1>üöÄ Indy Studio Pro</h1>
    <h2>Your AI-Powered Code Editor</h2>
    <p style="color:var(--muted);max-width:600px">Create beautiful web projects with intelligent code assistance, real-time preview, and seamless file management.</p>
    
    <div class="news-section">
      <h3 style="color:var(--text);margin-bottom:20px;font-size:18px">üì∞ What's New</h3>
      <div class="news-item">
        <h3>‚ú® Advanced Diff System</h3>
        <p>AI code suggestions now show a beautiful diff view with red (removed) and green (added) highlighting. Accept or reject changes with one click!</p>
        <div class="news-date">December 2025</div>
      </div>
    </div>
  </div>

  <div id="editorSection" style="display:none">
    <div id="editorWrap">
      <div id="lines"></div>
      <textarea id="editor" spellcheck="false" placeholder="Start coding..."></textarea>
      <div id="highlightOverlay"></div>
      <div id="diffOverlay"></div>
      <div id="diffControls">
        <button class="btn success" id="acceptDiff">‚úì Accept</button>
        <button class="btn danger" id="rejectDiff">‚úó Reject</button>
      </div>
      <!-- suggestion dropdown -->
      <div id="suggestionDropdown" class="suggestion-dropdown"></div>
    </div>
  </div>
</div>

<div id="previewPanel" class="collapsed">
  <button id="previewToggle">‚ñ∂</button>
  <div id="previewError"></div>
  <iframe id="frame" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<div id="indy" class="collapsed">
  <button id="indyToggle">INDY AI</button>
  <header id="indyHeader">INDY AI ‚Ä¢ Sunshine 2.0 <span id="indyThinking" style="margin-left:auto;display:none"><span class="thinking"><span></span><span></span><span></span></span></span></header>
  <div class="log" id="indyLog">
    <div class="msg">üëã Hey! I'm Indy, your AI coding assistant. I can help you debug, explain code, suggest improvements, or answer questions about your project.</div>
  </div>
  <input placeholder="Ask Indy anything..." id="indyInput">
</div>

<!-- console panel -->
<div id="appConsole" style="position:fixed;right:400px;bottom:12px;width:380px;max-height:240px;background:#0f0f12;border:1px solid #222;border-radius:10px;overflow:auto;padding:10px;z-index:95;display:none">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <strong style="flex:1">Console</strong>
    <button class="btn secondary" id="clearConsole">Clear</button>
    <button class="btn secondary" id="closeConsole">Hide</button>
  </div>
  <div id="consoleLog" style="font-size:12px;color:#ddd;overflow:auto;max-height:180px"></div>
</div>
<button id="showConsoleBtn">Show Console</button>

<div id="tutorialOverlay">
  <div class="tutorial-arrow" id="tutorialArrow"></div>
  <div class="tutorial-step" id="tutorialStep">
    <h3 id="tutorialTitle">Welcome to Indy Studio</h3>
    <div id="tutorialText" style="color:var(--muted)"></div>
    <div class="tutorial-controls">
      <button class="btn secondary" id="tutorialPrev">Prev</button>
      <button class="btn" id="tutorialNext">Next</button>
      <button class="btn secondary" id="tutorialEnd">End</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  // ELEMENTS
  const filesEl = document.getElementById('files');
  const editor = document.getElementById('editor');
  const lines = document.getElementById('lines');
  const highlightOverlay = document.getElementById('highlightOverlay');
  const diffOverlay = document.getElementById('diffOverlay');
  const filenameEl = document.getElementById('filename');
  const unsavedBadge = document.getElementById('unsavedBadge');
  const frame = document.getElementById('frame');
  const indyLog = document.getElementById('indyLog');
  const indyInput = document.getElementById('indyInput');
  const autoRunCheck = document.getElementById('autoRun');
  const autoSuggestCheck = document.getElementById('autoSuggest');
  const previewError = document.getElementById('previewError');
  const previewPanel = document.getElementById('previewPanel');
  const previewToggle = document.getElementById('previewToggle');
  const toastEl = document.getElementById('toast');
  const editorWrap = document.getElementById('editorWrap');
  const diffControls = document.getElementById('diffControls');
  const welcomeScreen = document.getElementById('welcomeScreen');
  const editorSection = document.getElementById('editorSection');
  const projectList = document.getElementById('projectList');
  const fileSection = document.getElementById('fileSection');
  const indyEl = document.getElementById('indy');
  const indyToggle = document.getElementById('indyToggle');
  const indyThinking = document.getElementById('indyThinking');
  const appConsole = document.getElementById('appConsole');
  const consoleLog = document.getElementById('consoleLog');
  const clearConsoleBtn = document.getElementById('clearConsole');
  const closeConsoleBtn = document.getElementById('closeConsole');
  const suggestionDropdown = document.getElementById('suggestionDropdown');
  const showConsoleBtn = document.getElementById('showConsoleBtn');

  // tutorial elements
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  const tutorialArrow = document.getElementById('tutorialArrow');
  const tutorialStep = document.getElementById('tutorialStep');
  const tutorialTitle = document.getElementById('tutorialTitle');
  const tutorialText = document.getElementById('tutorialText');
  const tutorialPrev = document.getElementById('tutorialPrev');
  const tutorialNext = document.getElementById('tutorialNext');
  const tutorialEnd = document.getElementById('tutorialEnd');

  // STATE
  let projects = JSON.parse(localStorage.getItem('indy-projects') || '{}');
  let currentProject = localStorage.getItem('indy-current-project') || null;
  let currentFile = localStorage.getItem('indy-current-file') || null;
  let previewCollapsed = JSON.parse(localStorage.getItem('indy-preview-collapsed') || 'true');
  let autoRunEnabled = JSON.parse(localStorage.getItem('indy-auto-run') || 'false');
  let indyCollapsed = JSON.parse(localStorage.getItem('indy-collapsed') || 'true');
  let autoSuggestEnabled = JSON.parse(localStorage.getItem('indy-auto-suggest') || 'true');

  let indyHistory = [];
  let pendingCode = null;
  let originalCode = null;
  let editorDirty = false; // tracks unsaved local edits

  // UTILITIES
  function persistProjects() {
    localStorage.setItem('indy-projects', JSON.stringify(projects));
  }

  function toast(msg, timeout=2000) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), timeout);
    logConsole(msg);
  }

  function logConsole(msg) {
    const row = document.createElement('div');
    row.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    consoleLog.appendChild(row);
    consoleLog.scrollTop = consoleLog.scrollHeight;

    // If console is hidden show the small button so user can reopen
    if (appConsole.style.display === 'none' || appConsole.style.display === '') {
      showConsoleBtn.style.display = 'block';
    } else {
      appConsole.style.display = 'block';
      showConsoleBtn.style.display = 'none';
    }
  }

  function getExt(name) {
    const parts = name.split('.');
    return parts.length > 1 ? parts.pop().toLowerCase() : '';
  }

  function normalizeName(name) {
    name = name.trim();
    if (!name) return 'untitled.txt';
    return name;
  }

  // INITIAL UI STATE
  if (previewCollapsed) {
    previewPanel.classList.add('collapsed');
    previewToggle.textContent = '‚ñ∂';
  } else {
    previewPanel.classList.remove('collapsed');
    previewToggle.textContent = '‚óÄ';
  }

  autoRunCheck.checked = autoRunEnabled;
  autoSuggestCheck.checked = autoSuggestEnabled;

  if (indyCollapsed) {
    indyEl.classList.add('collapsed');
  } else {
    indyEl.classList.remove('collapsed');
  }

  // DROPDOWNS
  document.querySelectorAll('.dropdown-btn').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      const dropdown = btn.nextElementSibling;
      document.querySelectorAll('.dropdown-content').forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
      });
      dropdown.classList.toggle('show');
    };
  });
  document.addEventListener('click', () => {
    document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
  });

  // SAVE/UNSAVED HANDLING
  function setDirty(d) {
    editorDirty = d;
    unsavedBadge.style.display = d ? 'inline' : 'none';
  }

  function save() {
    if (!currentFile || !currentProject) return;
    // ensure we don't save when editor is in read-only diff state
    if (editor.readOnly) return;
    projects[currentProject].files[currentFile] = editor.value;
    persistProjects();

    // Persist current open state
    localStorage.setItem('indy-current-project', currentProject);
    localStorage.setItem('indy-current-file', currentFile);

    setDirty(false);
    toast('Saved!');
    logConsole(`Saved ${currentFile}`);
  }

  // SYNTAX HIGHLIGHT
  function highlightSyntax(code) {
    return code
      .replace(/\b(function|const|let|var|if|else|for|while|return|class|import|export|async|await|try|catch|new|this|typeof|instanceof|def)\b/g, '<span class="kw">$1</span>')
      .replace(/('([^'\\]|\\.)*'|"([^"\\]|\\.)*"|`([^`\\]|\\.)*`)/g, '<span class="str">$1</span>')
      .replace(/\b(\d+\.?\d*)\b/g, '<span class="num">$1</span>')
      .replace(/(\/\/[^\n]*|\/\*[\s\S]*?\*\/|#.*$)/gm, '<span class="com">$1</span>')
      .replace(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(/g, '<span class="fn">$1</span>(')
      .replace(/\b(document|window|console|Math|Array|Object|String|Number|print)\b/g, '<span class="var">$1</span>');
  }

  function updateHighlight() {
    const code = editor.value;
    const highlighted = highlightSyntax(code.replace(/</g, '&lt;').replace(/>/g, '&gt;'));
    highlightOverlay.innerHTML = highlighted;
    highlightOverlay.scrollTop = editor.scrollTop;
    highlightOverlay.scrollLeft = editor.scrollLeft;
  }

  // FILE / PROJECT MANAGEMENT
  function createNewProject() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999';
    modal.innerHTML = `
      <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;padding:24px;width:420px;box-shadow:0 8px 32px rgba(0,0,0,0.6)">
        <h3 style="margin:0 0 16px;color:var(--text);font-size:18px">Create New Project</h3>
        <input id="projectNameInput" type="text" placeholder="Project name"
          style="width:100%;background:#0a0a0a;border:1px solid #2a2a2a;color:var(--text);padding:10px;border-radius:6px;font-size:14px;margin-bottom:16px;outline:none;font-family:inherit">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn secondary" id="modalCancel">Cancel</button>
          <button class="btn" id="modalCreate">Create</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    const input = modal.querySelector('#projectNameInput');
    input.focus();
    input.value = 'My Project';
    input.select();

    modal.querySelector('#modalCancel').onclick = () => modal.remove();
    modal.querySelector('#modalCreate').onclick = () => {
      const name = input.value.trim();
      if (!name) return;

      const projectId = 'proj_' + Date.now();
      projects[projectId] = {
        name: name,
        files: {
          'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${name}</title>
</head>
<body>
  <h1>Welcome to ${name}</h1>
  <p>Start coding!</p>
</body>
</html>`
        },
        folders: { 'Root': ['index.html'] }
      };

      persistProjects();
      refreshProjects();
      openProject(projectId);
      toast('Project created!');
      modal.remove();
    };

    input.onkeydown = (e) => {
      if (e.key === 'Enter') modal.querySelector('#modalCreate').click();
      if (e.key === 'Escape') modal.remove();
    };
  }

  function openProject(projectId) {
    if (currentFile) save(); // save before switching
    currentProject = projectId;
    localStorage.setItem('indy-current-project', currentProject);

    welcomeScreen.classList.remove('active');
    editorSection.style.display = 'flex';
    fileSection.style.display = 'block';

    document.getElementById('backToProjects').style.display = 'inline-block';
    document.getElementById('fileDropdown').style.display = 'inline-block';
    document.getElementById('runDropdown').style.display = 'inline-block';
    document.getElementById('save').style.display = 'inline-block';
    document.getElementById('pyMaker').style.display = 'inline-block';
    filenameEl.style.display = 'block';

    refreshFiles();
    refreshProjects();

    const firstFile = projects[projectId].folders['Root'][0];
    if (firstFile) openFile(firstFile);
    buildHTML();
    adjustDiffControls();
  }

  function closeProject() {
    if (currentFile) save();
    currentProject = null;
    currentFile = null;

    localStorage.removeItem('indy-current-project');
    localStorage.removeItem('indy-current-file');

    welcomeScreen.classList.add('active');
    editorSection.style.display = 'none';
    fileSection.style.display = 'none';

    document.getElementById('backToProjects').style.display = 'none';
    document.getElementById('fileDropdown').style.display = 'none';
    document.getElementById('runDropdown').style.display = 'none';
    document.getElementById('save').style.display = 'none';
    filenameEl.style.display = 'none';
    document.getElementById('pyMaker').style.display = 'none';

    previewPanel.classList.add('collapsed');
    previewToggle.textContent = '‚ñ∂';
    localStorage.setItem('indy-preview-collapsed', 'true');

    refreshProjects();
  }

  function refreshProjects() {
    projectList.innerHTML = '';
    Object.keys(projects).forEach(projectId => {
      const li = document.createElement('li');
      li.className = 'project-item';
      li.textContent = projects[projectId].name;
      li.onclick = () => openProject(projectId);

      li.classList.toggle('active', projectId === currentProject);

      const delBtn = document.createElement('span');
      delBtn.className = 'delete';
      delBtn.textContent = '√ó';
      delBtn.style.opacity = '0';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999';
        modal.innerHTML = `
          <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;padding:24px;width:400px">
            <h3 style="margin:0 0 12px;color:var(--text);font-size:18px">Delete Project</h3>
            <p style="margin:0 0 20px;color:var(--muted);font-size:14px">Are you sure you want to delete <strong style="color:var(--text)">"${projects[projectId].name}"</strong>? All files will be permanently lost.</p>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn secondary" id="modalCancel">Cancel</button>
              <button class="btn danger" id="modalDelete">Delete Project</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#modalCancel').onclick = () => modal.remove();
        modal.querySelector('#modalDelete').onclick = () => {
          delete projects[projectId];
          persistProjects();
          if (currentProject === projectId) closeProject();
          refreshProjects();
          toast('Project deleted!');
          modal.remove();
        };
      };
      li.onmouseenter = () => delBtn.style.opacity = '1';
      li.onmouseleave = () => delBtn.style.opacity = '0';
      li.appendChild(delBtn);
      projectList.appendChild(li);
    });
  }

  function openFile(name) {
    if (currentFile) save();
    currentFile = name;
    localStorage.setItem('indy-current-file', currentFile);

    filenameEl.value = name;
    editor.value = projects[currentProject].files[name] || '';
    setDirty(false);
    editor.focus();
    document.querySelectorAll('.file-item').forEach(li =>
      li.classList.toggle('active', li.dataset.name === name)
    );
    updateLines();
    updateHighlight();
  }

  function updateLines() {
    const lineCount = editor.value.split('\n').length;
    lines.innerHTML = Array.from({length: lineCount}, (_, i) => i + 1).join('\n');
  }

  function refreshFiles() {
    if (!currentProject) return;
    filesEl.innerHTML = '';
    const folders = projects[currentProject].folders;

    Object.keys(folders).forEach(folderName => {
      const folderDiv = document.createElement('div');
      folderDiv.className = 'folder';

      const header = document.createElement('div');
      header.className = 'folder-header';
      header.textContent = folderName;
      header.onclick = (e) => {
        if (e.target === header) {
          header.classList.toggle('collapsed');
          content.classList.toggle('hidden');
        }
      };

      const content = document.createElement('div');
      content.className = 'folder-content';

      folders[folderName].forEach(fileName => {
        const li = document.createElement('li');
        li.className = 'file-item';
        li.textContent = fileName;
        li.dataset.name = fileName;
        li.dataset.ext = getExt(fileName);
        li.dataset.folder = folderName;
        li.draggable = true;
        li.onclick = () => openFile(fileName);

        li.ondragstart = (e) => {
          e.dataTransfer.setData('text/plain', fileName);
          e.dataTransfer.effectAllowed = 'move';
          li.classList.add('dragging');
        };

        li.ondragend = () => li.classList.remove('dragging');

        const delBtn = document.createElement('span');
        delBtn.className = 'delete';
        delBtn.textContent = '√ó';
        delBtn.onclick = (e) => {
          e.stopPropagation();

          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999';
          modal.innerHTML = `
            <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;padding:24px;width:400px">
              <h3 style="margin:0 0 12px;color:var(--text);font-size:18px">Delete File</h3>
              <p style="margin:0 0 20px;color:var(--muted);font-size:14px">Are you sure you want to delete <strong style="color:var(--text)">${fileName}</strong>?</p>
              <div style="display:flex;gap:8px;justify-content:flex-end">
                <button class="btn secondary" id="modalCancel">Cancel</button>
                <button class="btn danger" id="modalDelete">Delete</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          modal.querySelector('#modalCancel').onclick = () => modal.remove();
          modal.querySelector('#modalDelete').onclick = () => {
            delete projects[currentProject].files[fileName];
            folders[folderName] = folders[folderName].filter(f => f !== fileName);
            persistProjects();
            if (currentFile === fileName) {
              currentFile = null;
              editor.value = '';
              filenameEl.value = '';
              localStorage.removeItem('indy-current-file');
            }
            refreshFiles();
            toast('Deleted!');
            modal.remove();
          };
        };

        li.appendChild(delBtn);
        content.appendChild(li);
      });

      header.ondragover = (e) => {
        e.preventDefault();
        header.style.background = '#252525';
      };

      header.ondragleave = () => {
        header.style.background = '';
      };

      header.ondrop = (e) => {
        e.preventDefault();
        header.style.background = '';
        const fileName = e.dataTransfer.getData('text/plain');
        const oldFolder = Object.keys(folders).find(f => folders[f].includes(fileName));
        if (oldFolder && oldFolder !== folderName) {
          folders[oldFolder] = folders[oldFolder].filter(f => f !== fileName);
          folders[folderName].push(fileName);
          persistProjects();
          refreshFiles();
          toast(`Moved to ${folderName}!`);
        }
      };

      folderDiv.appendChild(header);
      folderDiv.appendChild(content);
      filesEl.appendChild(folderDiv);
    });
  }

  // DIFF UI
  function showDiff(newCode) {
    originalCode = editor.value;
    pendingCode = newCode;

    const oldLines = originalCode.split('\n');
    const newLines = newCode.split('\n');

    let diffHTML = '';
    const maxLen = Math.max(oldLines.length, newLines.length);

    for (let i = 0; i < maxLen; i++) {
      const oldLine = oldLines[i] || '';
      const newLine = newLines[i] || '';

      if (oldLine !== newLine) {
        if (oldLine && !newLine) {
          diffHTML += `<div class="diff-remove">${escapeHtml(oldLine) || '&nbsp;'}</div>`;
        } else if (!oldLine && newLine) {
          diffHTML += `<div class="diff-add">${escapeHtml(newLine)}</div>`;
        } else {
          if (oldLine) diffHTML += `<div class="diff-remove">${escapeHtml(oldLine)}</div>`;
          if (newLine) diffHTML += `<div class="diff-add">${escapeHtml(newLine)}</div>`;
        }
      } else {
        diffHTML += `<div>${escapeHtml(oldLine)}</div>`;
      }
    }

    diffOverlay.innerHTML = diffHTML;
    diffOverlay.classList.add('active');
    diffControls.classList.add('active');
    editorWrap.classList.add('pending');
    editor.readOnly = true;
    adjustDiffControls();
  }

  function acceptDiff() {
    editor.value = pendingCode;
    editor.readOnly = false;
    diffOverlay.classList.remove('active');
    diffControls.classList.remove('active');
    editorWrap.classList.remove('pending');
    updateLines();
    updateHighlight();
    save();
    toast('Changes applied!');
  }

  function rejectDiff() {
    editor.value = originalCode;
    editor.readOnly = false;
    diffOverlay.classList.remove('active');
    diffControls.classList.remove('active');
    editorWrap.classList.remove('pending');
    setDirty(false);
    toast('Changes rejected');
  }

  function adjustDiffControls() {
    const indyOpen = !indyEl.classList.contains('collapsed');
    const indyWidth = indyOpen ? indyEl.getBoundingClientRect().width : 0;
    const previewOpen = !previewPanel.classList.contains('collapsed');
    const previewWidth = previewOpen ? previewPanel.getBoundingClientRect().width : 0;
    // place diffControls so they're not under Indy or Preview
    const minRight = Math.max(indyWidth, previewWidth);
    const rightOffset = minRight ? (minRight + 20) : 10;
    diffControls.style.right = rightOffset + 'px';
    diffControls.style.zIndex = 120;
  }

  window.addEventListener('resize', adjustDiffControls);
  const observer = new MutationObserver(adjustDiffControls);
  observer.observe(indyEl, { attributes: true, attributeFilter: ['class'] });
  observer.observe(previewPanel, { attributes: true, attributeFilter: ['class'] });

  // PREVIEW / RUN
  function buildHTML(runFromUser=true) {
    if (!currentProject) return;
    previewError.style.display = 'none';

    // require save before manual Run Now
    if (runFromUser && editorDirty) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999';
      modal.innerHTML = `
        <div style="background:#121212;border:1px solid #222;border-radius:12px;padding:20px;width:420px">
          <h3 style="margin:0 0 8px;color:var(--text)">Save before running</h3>
          <p style="color:var(--muted);margin:0 0 16px">You have unsaved changes. The preview only reflects saved files. What would you like to do?</p>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn secondary" id="runCancel">Cancel</button>
            <button class="btn" id="saveRun">Save & Run</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('#runCancel').onclick = () => modal.remove();
      modal.querySelector('#saveRun').onclick = () => {
        save();
        modal.remove();
        buildHTML(false);
      };
      return;
    }

    try {
      let html = projects[currentProject].files['index.html'] || '<!DOCTYPE html><html><head></head><body></body></html>';
      let css = '';
      let js = '';

      Object.keys(projects[currentProject].files).forEach(f => {
        if (getExt(f) === 'css') css += projects[currentProject].files[f] + '\n';
        if (getExt(f) === 'js') js += projects[currentProject].files[f] + '\n';
      });

      if (css && !html.includes('<style>')) {
        const styleTag = `<style>${css}</style>`;
        html = html.includes('</head>')
          ? html.replace('</head>', styleTag + '</head>')
          : html.replace('<html>', '<html><head>' + styleTag + '</head>');
      }

      if (js && !html.includes('<script>')) {
        const scriptTag = `<script>${js.replace(/<\/script>/gi, '<\\/script>')}<\/script>`;
        html = html.includes('</body>')
          ? html.replace('</body>', scriptTag + '</body>')
          : html += scriptTag;
      }

      const blob = new Blob([html], { type: 'text/html' });
      frame.src = URL.createObjectURL(blob);
      toast('Running!');
      logConsole('Preview updated');
    } catch (e) {
      previewError.textContent = 'Error: ' + e.message;
      previewError.style.display = 'block';
      logConsole('Preview error: ' + e.message);
    }
  }

  // EDITOR EVENTS, AUTOSAVE, AUTORUN
  editor.oninput = () => {
    updateLines();
    updateHighlight();
    setDirty(true);

    // Auto-save after 1 second of no typing
    clearTimeout(editor.autoSaveTimer);
    editor.autoSaveTimer = setTimeout(() => {
      if (currentFile && currentProject) {
        save();
      }
    }, 1000);

    if (autoRunCheck.checked) {
      clearTimeout(editor.autoRunTimer);
      editor.autoRunTimer = setTimeout(() => {
        if (currentFile && currentProject) {
          // commit the buffer so preview matches
          projects[currentProject].files[currentFile] = editor.value;
          persistProjects();
        }
        buildHTML(false);
      }, 800);
    }

    if (autoSuggestCheck.checked) {
      handleAutocomplete();
    } else {
      hideSuggestionDropdown();
    }
  };

  // Save on blur and beforeunload to avoid accidental data loss
  editor.addEventListener('blur', () => {
    if (currentFile && currentProject && editorDirty) save();
  });

  window.addEventListener('beforeunload', (e) => {
    if (currentFile && currentProject && editorDirty) {
      save(); // localStorage.setItem is synchronous
      // optionally prompt the user:
      // e.preventDefault();
      // e.returnValue = '';
    }
  });

  editor.onscroll = () => {
    lines.scrollTop = editor.scrollTop;
    highlightOverlay.scrollTop = editor.scrollTop;
    highlightOverlay.scrollLeft = editor.scrollLeft;
  };

  editor.onkeydown = (e) => {
    if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      save();
    }

    // accept suggestion with Tab
    if (e.key === 'Tab' && suggestionDropdown.style.display === 'block') {
      e.preventDefault();
      const first = suggestionDropdown.querySelector('.suggestion-item');
      if (first) applySuggestion(first.dataset.insert || first.textContent);
      hideSuggestionDropdown();
      return;
    }
  };

  // UI buttons
  document.getElementById('newProject').onclick = createNewProject;
  document.getElementById('backToProjects').onclick = closeProject;

  document.getElementById('newFile').onclick = () => {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999';
    modal.innerHTML = `
      <div style="background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;padding:20px;width:440px">
        <h3 style="margin:0 0 12px;color:var(--text)">Create New File</h3>
        <input id="newFilename" type="text" placeholder="filename (e.g. script.js or main.py)"
          style="width:100%;background:#0a0a0a;border:1px solid #2a2a2a;color:var(--text);padding:10px;border-radius:6px;font-size:14px;margin-bottom:12px;outline:none">
        <select id="fileType" style="width:100%;padding:8px;border-radius:6px;background:#0a0a0a;border:1px solid #2a2a2a;color:var(--text);margin-bottom:12px">
          <option value="html">HTML</option>
          <option value="css">CSS</option>
          <option value="js">JavaScript</option>
          <option value="py">Python</option>
        </select>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn secondary" id="modalCancel">Cancel</button>
          <button class="btn" id="modalCreate">Create</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const input = modal.querySelector('#newFilename');
    const select = modal.querySelector('#fileType');
    input.focus();

    modal.querySelector('#modalCancel').onclick = () => modal.remove();
    modal.querySelector('#modalCreate').onclick = () => {
      let name = input.value.trim();
      const type = select.value;
      if (!name) name = `untitled.${type}`;
      if (!name.includes('.')) name = `${name}.${type}`;
      name = normalizeName(name);
      if (!projects[currentProject].files[name]) {
        // create template content
        let content = '';
        if (getExt(name) === 'html') {
          content = `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${name}</title></head><body>\n\n</body></html>`;
        } else if (getExt(name) === 'css') {
          content = `/* ${name} */\nbody { font-family: sans-serif; }`;
        } else if (getExt(name) === 'js') {
          content = `// ${name}\nconsole.log('hello');`;
        } else if (getExt(name) === 'py') {
          content = `# ${name}\ndef main():\n    print('Hello from ${name}')\n\nif __name__ == '__main__':\n    main()`;
        }
        projects[currentProject].files[name] = content;
        projects[currentProject].folders['Root'].push(name);
        persistProjects();
        refreshFiles();
        openFile(name);
        toast('File created');
      } else {
        toast('File already exists');
      }
      modal.remove();
    };
  };

  // Quick python maker
  document.getElementById('makePy').onclick = () => {
    document.getElementById('newFile').click();
    setTimeout(() => {
      const sel = document.querySelector('#fileType');
      if (sel) sel.value = 'py';
      const name = document.querySelector('#newFilename');
      if (name) name.value = `script_${Date.now()}.py`;
    }, 50);
  };

  document.getElementById('newFolder').onclick = () => {
    const name = prompt('Folder name', 'New Folder');
    if (!name) return;
    projects[currentProject].folders[name] = [];
    persistProjects();
    refreshFiles();
    toast('Folder created');
  };

  document.getElementById('addImage').onclick = () => {
    toast('Image add not implemented in this demo');
  };

  document.getElementById('rename').onclick = () => {
    if (!currentFile) return toast('No file selected');
    const newName = prompt('Rename file to (include extension if you want)', currentFile);
    if (!newName) return;
    const normalized = normalizeName(newName);
    if (normalized === currentFile) return toast('No change');
    if (projects[currentProject].files[normalized]) {
      if (!confirm(`${normalized} already exists. Overwrite?`)) return toast('Rename cancelled');
    }
    projects[currentProject].files[normalized] = projects[currentProject].files[currentFile];
    // replace in folders
    Object.keys(projects[currentProject].folders).forEach(f => {
      projects[currentProject].folders[f] = projects[currentProject].folders[f].map(x => x === currentFile ? normalized : x);
    });
    delete projects[currentProject].files[currentFile];
    currentFile = normalized;
    persistProjects();
    refreshFiles();
    openFile(normalized);
    toast('Renamed');
  };

  document.getElementById('deleteFile').onclick = () => {
    if (!currentFile) return toast('No file selected');
    if (!confirm(`Delete ${currentFile}?`)) return;
    delete projects[currentProject].files[currentFile];
    Object.keys(projects[currentProject].folders).forEach(f => {
      projects[currentProject].folders[f] = projects[currentProject].folders[f].filter(x => x !== currentFile);
    });
    currentFile = null;
    persistProjects();
    refreshFiles();
    openProject(currentProject);
    toast('Deleted file');
  };

  document.getElementById('save').onclick = save;
  document.getElementById('runNow').onclick = () => buildHTML(true);
  document.getElementById('acceptDiff').onclick = acceptDiff;
  document.getElementById('rejectDiff').onclick = rejectDiff;

  // Preview toggle with persistence
  const togglePreviewHandler = () => {
    previewPanel.classList.toggle('collapsed');
    const collapsed = previewPanel.classList.contains('collapsed');
    previewToggle.textContent = collapsed ? '‚ñ∂' : '‚óÄ';
    localStorage.setItem('indy-preview-collapsed', JSON.stringify(collapsed));
    adjustDiffControls();
  };
  document.getElementById('togglePreview').onclick = togglePreviewHandler;
  previewToggle.onclick = togglePreviewHandler;

  // Auto-run toggle persistence
  document.getElementById('autoRunToggle').onclick = () => {
    autoRunEnabled = autoRunCheck.checked;
    localStorage.setItem('indy-auto-run', JSON.stringify(autoRunEnabled));
  };

  // Auto-suggest toggle persistence
  document.getElementById('autoSuggestToggle').onclick = () => {
    autoSuggestEnabled = autoSuggestCheck.checked;
    localStorage.setItem('indy-auto-suggest', JSON.stringify(autoSuggestEnabled));
    if (!autoSuggestEnabled) hideSuggestionDropdown();
  };

  // Indy toggle persistence
  indyToggle.addEventListener('click', () => {
    indyEl.classList.toggle('collapsed');
    indyCollapsed = indyEl.classList.contains('collapsed');
    localStorage.setItem('indy-collapsed', JSON.stringify(indyCollapsed));
    adjustDiffControls();
  });

  // Console hide/show behavior
  closeConsoleBtn.onclick = () => {
    appConsole.style.display = 'none';
    showConsoleBtn.style.display = 'block';
  };
  clearConsoleBtn.onclick = () => { consoleLog.innerHTML = ''; };
  showConsoleBtn.onclick = () => {
    appConsole.style.display = 'block';
    showConsoleBtn.style.display = 'none';
  };

  // Indy thinking indicator
  function setIndyThinking(on) {
    indyThinking.style.display = on ? 'inline-block' : 'none';
  }

  // INDY AI CHAT (demo fetch)
  indyInput.addEventListener('keydown', async (e) => {
    if (e.key !== 'Enter' || !e.target.value.trim()) return;

    const question = e.target.value.trim();
    e.target.value = '';

    const userMsg = document.createElement('div');
    userMsg.className = 'msg';
    userMsg.innerHTML = `<b>You:</b> ${escapeHtml(question)}`;
    indyLog.appendChild(userMsg);
    indyLog.scrollTop = indyLog.scrollHeight;

    indyHistory.push({role: 'user', content: question});

    let context = `You are Indy, an AI coding assistant. Be helpful and concise.
Current file: ${currentFile || 'none'}
Current code:
\`\`\`
${editor.value.substring(0, 2000)}
\`\`\`
Project: ${currentProject ? projects[currentProject].name : 'none'}
Files: ${currentProject ? Object.keys(projects[currentProject].files).join(', ') : 'none'}
If you provide code, wrap it in triple backticks with the language like \`\`\`javascript or \`\`\`html
Recent conversation:
${indyHistory.slice(-4).map(m => `${m.role}: ${m.content}`).join('\n')}
Answer:`;

    try {
      setIndyThinking(true);
      logConsole('Asking Indy...');
      // Demo/placeholder endpoint; in real app replace with actual LLM endpoint
      const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(context)}`);
      const answer = await res.text();

      setIndyThinking(false);
      logConsole('Indy responded');

      indyHistory.push({role: 'assistant', content: answer});

      const codeMatch = answer.match(/```(\w+)?\n([\s\S]+?)```/);

      if (codeMatch) {
        const code = codeMatch[2].trim();
        const beforeCode = answer.split('```')[0].trim();
        const afterCode = answer.split('```')[2] ? answer.split('```')[2].trim() : '';

        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg';
        let msgHTML = '';
        if (beforeCode) msgHTML += `<b>Indy:</b> ${escapeHtml(beforeCode)}<br><br>`;
        msgHTML += `<div class="code-suggestion"><pre>${escapeHtml(code)}</pre><button class="apply-btn" data-code="${encodeURIComponent(code)}">Apply this code</button></div>`;
        if (afterCode) msgHTML += `<br>${escapeHtml(afterCode)}`;
        aiMsg.innerHTML = msgHTML;
        indyLog.appendChild(aiMsg);

        aiMsg.querySelector('.apply-btn').onclick = function() {
          const suggestionCode = decodeURIComponent(this.dataset.code);
          showDiff(suggestionCode);
        };
      } else {
        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg';
        aiMsg.innerHTML = `<b>Indy:</b> ${escapeHtml(answer).replace(/\n/g, '<br>')}`;
        indyLog.appendChild(aiMsg);
      }

      indyLog.scrollTop = indyLog.scrollHeight;
    } catch (err) {
      setIndyThinking(false);
      const errMsg = document.createElement('div');
      errMsg.className = 'msg';
      errMsg.innerHTML = `<b>Error:</b> Could not reach Indy.`;
      indyLog.appendChild(errMsg);
      logConsole('Indy error: ' + (err.message || 'unknown'));
    }
  });

  // Escape helper
  function escapeHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // AUTOCOMPLETE (simple demo)
  const SUGGESTIONS = [
    {match: 'func', insert: 'function ', label: 'function ‚Äî JS'},
    {match: 'def', insert: 'def ', label: 'def ‚Äî PY'},
    {match: 'console', insert: 'console.log();', label: 'console.log'},
    {match: 'for', insert: 'for (let i = 0; i < ; i++) {\n\n}', label: 'for loop'},
  ];

  function getCurrentWord() {
    const selStart = editor.selectionStart;
    const before = editor.value.slice(0, selStart);
    const m = before.match(/([a-zA-Z0-9_$]+)$/);
    return m ? m[1] : '';
  }

  function handleAutocomplete() {
    const word = getCurrentWord();
    if (!word) return hideSuggestionDropdown();
    const matches = SUGGESTIONS.filter(s => s.match.startsWith(word));
    if (matches.length === 0) return hideSuggestionDropdown();

    // approximate caret position
    const rect = editor.getBoundingClientRect();
    const linesBefore = editor.value.slice(0, editor.selectionStart).split('\n');
    const row = linesBefore.length;
    const col = linesBefore[linesBefore.length - 1].length;
    const lineHeight = parseInt(window.getComputedStyle(editor).lineHeight) || 18;
    const top = rect.top + (row - 1) * lineHeight - editor.scrollTop + 52; // account for top bar height
    const left = rect.left + col * 7 + 50; // approximate char width + gutter offset

    suggestionDropdown.innerHTML = '';
    matches.forEach(m => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.textContent = m.insert;
      div.dataset.insert = m.insert;
      div.title = m.label;
      div.onclick = () => { applySuggestion(m.insert); hideSuggestionDropdown(); };
      suggestionDropdown.appendChild(div);
    });

    // clamp position to viewport
    suggestionDropdown.style.top = Math.min(window.innerHeight - 60, Math.max(60, top)) + 'px';
    suggestionDropdown.style.left = Math.min(window.innerWidth - 200, Math.max(20, left)) + 'px';
    suggestionDropdown.style.display = 'block';
  }

  function applySuggestion(text) {
    const start = editor.selectionStart;
    const before = editor.value.slice(0, start);
    const m = before.match(/([a-zA-Z0-9_$]+)$/);
    const tokenStart = m ? start - m[1].length : start;
    editor.value = editor.value.slice(0, tokenStart) + text + editor.value.slice(editor.selectionEnd);
    editor.selectionStart = editor.selectionEnd = tokenStart + text.length;
    updateLines();
    updateHighlight();
    editor.focus();
    setDirty(true);
  }

  function hideSuggestionDropdown() {
    suggestionDropdown.style.display = 'none';
  }

  // TUTORIAL (basic)
  const tutorialSteps = [
    {
      title: 'Welcome',
      text: 'Welcome to Indy Studio! This quick tutorial will point out a few important features.',
      arrow: null
    },
    {
      title: 'Ask Indy',
      text: 'You can ask Indy questions about your code. Click the INDY AI toggle on the right to open it.',
      arrow: () => {
        const t = document.getElementById('indyToggle');
        const r = t.getBoundingClientRect();
        return { top: (r.top - 40) + 'px', left: (r.left - 220) + 'px' };
      }
    },
    {
      title: 'Save before Run',
      text: 'Always save your code before running. If you try to Run with unsaved changes, Indy Studio will prompt you to Save & Run.',
      arrow: () => {
        const t = document.getElementById('save');
        const r = t.getBoundingClientRect();
        return { top: (r.top + 8) + 'px', left: (r.left - 220) + 'px' };
      }
    },
    {
      title: 'Auto Suggestions',
      text: 'Auto code suggestions can help you type faster. You can toggle them in the Run ‚ñæ menu under "Auto Suggestions". You can turn them off anytime.',
      arrow: null
    },
  ];
  let tutorialIndex = 0;

  function showTutorial(startIndex=0) {
    tutorialIndex = startIndex;
    tutorialOverlay.classList.add('active');
    renderTutorialStep();
  }

  function renderTutorialStep() {
    const s = tutorialSteps[tutorialIndex];
    tutorialTitle.textContent = s.title;
    tutorialText.textContent = s.text;
    if (s.arrow) {
      const pos = s.arrow();
      tutorialArrow.style.display = 'block';
      tutorialArrow.style.top = pos.top;
      tutorialArrow.style.left = pos.left;
    } else {
      tutorialArrow.style.display = 'none';
    }
  }

  tutorialPrev.onclick = () => { tutorialIndex = Math.max(0, tutorialIndex - 1); renderTutorialStep(); };
  tutorialNext.onclick = () => { tutorialIndex = Math.min(tutorialSteps.length - 1, tutorialIndex + 1); renderTutorialStep(); };
  tutorialEnd.onclick = () => { tutorialOverlay.classList.remove('active'); localStorage.setItem('indy-tutorial-shown', 'true'); };
  document.getElementById('showTutorial').onclick = () => showTutorial(0);

  if (!localStorage.getItem('indy-tutorial-shown')) {
    setTimeout(() => showTutorial(0), 800);
  }

  // FRAME messages -> console
  window.addEventListener('message', (ev) => {
    logConsole('Frame: ' + (typeof ev.data === 'string' ? ev.data : JSON.stringify(ev.data)));
  });

  // helpers
  document.getElementById('pyMaker').onclick = () => document.getElementById('makePy').click();

  // INITIALIZE UI / RESTORE
  function ensureDefaultProject() {
    if (Object.keys(projects).length === 0) {
      const projectId = 'proj_' + Date.now();
      projects[projectId] = {
        name: 'Welcome Project',
        files: {
          'index.html': `<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Welcome</title></head><body><h1>Welcome</h1><p>Start coding!</p></body></html>`
        },
        folders: { 'Root': ['index.html'] }
      };
      persistProjects();
      currentProject = projectId;
      localStorage.setItem('indy-current-project', currentProject);
    }
  }

  ensureDefaultProject();
  refreshProjects();

  if (currentProject && projects[currentProject]) {
    welcomeScreen.classList.remove('active');
    openProject(currentProject);
    if (currentFile && projects[currentProject].files[currentFile]) {
      openFile(currentFile);
    }
  } else {
    welcomeScreen.classList.add('active');
  }
</script>
</body>
</html>
